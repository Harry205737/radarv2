<!DOCTYPE html>
<html>
<head>
    <title>RADAR 256</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; text-align: center; margin: 0; padding: 5px; }
        #map-box { position: relative; width: 256px; height: 256px; margin: 0 auto; background: #222; }
        #bg, #radar { position: absolute; top: 0; left: 0; width: 256px; height: 256px; }
        #bg { z-index: 1; }
        #radar { z-index: 2; opacity: 0.75; }
        .ui { margin: 10px 0; font-size: 12px; }
        button { padding: 6px 12px; background: #444; color: #fff; border: 1px solid #666; cursor: pointer; }
    </style>
</head>
<body>

    <div class="ui">
        <b>Laverton 128km</b><br>
        <span id="msg">Initialising...</span><br>
        <button onclick="f()">REFRESH</button>
    </div>

    <div id="map-box">
        <img id="bg" src="128melradar.jpg">
        <img id="radar">
    </div>

    <script>
        const M = document.getElementById('msg');
        const R = document.getElementById('radar');

        const f = () => {
            M.innerText = 'Syncing...';
            // We fetch the JSON to get the most recent valid timestamp
            fetch('https://api.rainviewer.com/public/weather-maps.json')
                .then(r => r.json())
                .then(j => {
                    const t = j.radar.past.at(-1).time;
                    const host = j.host || 'https://tilecache.rainviewer.com';
                    
                    // Zoom 6, X 56, Y 39 = Melbourne Area
                    // Color 1 (Original), Smooth 1, Snow 1
                    const url = `${host}/v2/radar/${t}/256/6/56/39/1/1_1.png`;
                    
                    R.src = url;
                    M.innerText = 'Updated: ' + new Date(t * 1000).toLocaleTimeString();
                })
                .catch(() => { 
                    M.innerText = 'API Error - Retrying...';
                    // Fallback attempt with a static host if JSON fails
                    const fallbackTime = Math.floor(Date.now() / 1000) - (Math.floor(Date.now() / 1000) % 600);
                    R.src = `https://tilecache.rainviewer.com/v2/radar/${fallbackTime}/256/6/56/39/1/1_1.png`;
                });
        };

        f();
        setInterval(f, 300000); 
    </script>
</body>
</html>
